<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gesture Volume Control</title>

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
    background: linear-gradient(135deg,#0f2027,#203a43,#2c5364);
    color: white;
    font-family: "Segoe UI", sans-serif;
}
body.light{
    background:#f4f6f9;
    color:#111;
}

.card{
    background: rgba(255,255,255,0.12);
    border-radius:18px;
    border:none;
}

/* Camera */
.video-box img{
    width:100%;
    border-radius:16px;
    border:3px solid rgba(255,255,255,0.25);
}

/* Bigger Graph */
#chart{
    height:340px !important;
}

/* Volume Bar */
.volume-bar{
    height:20px;
    background:#666;
    border-radius:12px;
    overflow:hidden;
}
.volume-fill{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,#00ff87,#ff9800,#ff3c3c);
    transition: width 0.3s ease;
}

/* Alerts */
.alert-box{
    padding:8px;
    border-radius:8px;
    font-weight:600;
}
.low{background:#2e7d32;}
.medium{background:#ff9800;}
.high{background:#c62828;}
</style>
</head>

<body>

<div class="container-fluid p-4">
<div class="row g-4">

<!-- LEFT COLUMN -->
<div class="col-lg-4">

    <!-- Camera -->
    <div class="card p-3 mb-3">
        <div class="video-box">
            <img src="{{ url_for('video_feed') }}">
        </div>
    </div>

    <!-- Calibration -->
    <div class="card p-3 mb-3">
        <h6 class="mb-2">Calibration</h6>
        <div class="row g-2">
            <div class="col">
                <input id="minVal" type="number" class="form-control" value="30">
            </div>
            <div class="col">
                <input id="maxVal" type="number" class="form-control" value="200">
            </div>
            <div class="col-12">
                <button class="btn btn-primary w-100" onclick="applyCalibration()">
                    Apply Calibration
                </button>
            </div>
        </div>
    </div>

    <!-- Volume Bar BELOW calibration -->
    <div class="card p-3">
        <div class="volume-bar mb-2">
            <div class="volume-fill" id="fill"></div>
        </div>
        <div class="d-flex justify-content-between align-items-center">
            <span>Volume: <b id="volume">0%</b></span>
            <span id="alert" class="alert-box low">Low Volume</span>
        </div>
    </div>

</div>

<!-- RIGHT COLUMN -->
<div class="col-lg-8">

    <!-- BIG GRAPH -->
    <div class="card p-4 mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Live Volume Graph</h5>
            <button class="btn btn-sm btn-outline-light" onclick="toggleTheme()">ðŸŒ™ / â˜€</button>
        </div>
        <canvas id="chart"></canvas>
    </div>

    <!-- Controls -->
    <div class="card p-3 mb-3 text-center">
        <button class="btn btn-success me-2" onclick="send('start')">Start</button>
        <button class="btn btn-danger me-2" onclick="send('stop')">Stop</button>
        <button class="btn btn-warning" onclick="send('freeze')">Freeze</button>
    </div>

    <!-- Metrics -->
    <div class="card p-3">
        <div class="row text-center">
            <div class="col"><b>Gesture</b><br><span id="gesture">-</span></div>
            <div class="col"><b>Distance</b><br><span id="distance">0</span></div>
            <div class="col"><b>Stability</b><br><span id="stability">0%</span></div>
            <div class="col"><b>FPS</b><br><span id="fps">0</span></div>
        </div>
    </div>

</div>

</div>
</div>

<script>
let vol=[], labels=[];

/* Chart (optimized) */
const ctx=document.getElementById("chart").getContext("2d");
const chart=new Chart(ctx,{
    type:"line",
    data:{labels:labels,datasets:[{
        data:vol,
        borderColor:"#00ff87",
        borderWidth:3,
        tension:0.25
    }]},
    options:{
        animation:false,
        responsive:true,
        plugins:{legend:{display:false}},
        scales:{y:{min:0,max:100}}
    }
});

/* Update UI */
function update(){
fetch("/metrics")
.then(r=>r.json())
.then(d=>{
    gesture.innerText=d.gesture;
    distance.innerText=d.distance;
    stability.innerText=d.stability+"%";
    fps.innerText=d.fps;
    volume.innerText=d.volume+"%";
    fill.style.width=d.volume+"%";

    const alert=document.getElementById("alert");
    alert.className="alert-box";

    if(d.volume<=30){
        alert.innerText="ðŸ”ˆ Low";
        alert.classList.add("low");
    }else if(d.volume<=70){
        alert.innerText="ðŸ”Š Medium";
        alert.classList.add("medium");
    }else{
        alert.innerText="âš  High";
        alert.classList.add("high");
    }

    if(vol.length>50){vol.shift();labels.shift();}
    vol.push(d.volume);labels.push("");
    chart.update("none");   // <-- faster redraw
});
}

function send(a){
fetch("/control",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action:a})
});
}

function applyCalibration(){
fetch("/calibrate",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({min:minVal.value,max:maxVal.value})
});
}

function toggleTheme(){
document.body.classList.toggle("light");
}

/* Slower interval = smoother + less CPU */
setInterval(update,400);
</script>

</body>
</html>
